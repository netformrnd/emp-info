<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NETFORM R&D - ì§ì› ì •ë³´ ì œì¶œ</title>
<style>
:root{--bg:#F1F5F9;--surface:#fff;--border:#e2e8f0;--accent:#3b82f6;--accent-dim:rgba(59,130,246,.08);--text:#0F172A;--sub:#64748b;--dim:#94a3b8;--green:#15803d;--green-dim:rgba(21,128,61,.08);--red:#dc2626;--radius:8px;--orange:#ea580c;--orange-dim:rgba(234,88,12,.08);}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Pretendard','Segoe UI','Malgun Gothic',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;font-size:15px;}
.hd{background:linear-gradient(135deg,#0F172A,#1E293B);padding:0 28px;height:52px;display:flex;align-items:center;justify-content:space-between;}
.hd-logo{font-size:15px;font-weight:700;color:#fff;display:flex;align-items:center;gap:8px;}
.hd-logo b{color:#667eea;font-size:16px;}
.wrap{max-width:820px;margin:0 auto;padding:28px 20px;}

/* ===== ê³µì§€ ===== */
.notice{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:28px 28px 24px;margin-bottom:24px;border-left:5px solid var(--accent);}
.notice h2{font-size:21px;margin-bottom:18px;color:var(--text);letter-spacing:-.3px;display:flex;align-items:center;gap:10px;}
.notice-badge{display:inline-flex;align-items:center;gap:5px;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff;padding:4px 14px;border-radius:8px;font-size:13px;font-weight:700;letter-spacing:.3px;box-shadow:0 2px 6px rgba(59,130,246,.25);}
.notice h2 .notice-title-text{font-weight:800;}
.notice-intro{font-size:15px;color:var(--text);line-height:1.7;margin-bottom:18px;}

.notice-section{margin-bottom:18px;}
.notice-section-title{font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.notice-section-title .num{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;background:var(--accent);color:#fff;border-radius:50%;font-size:12px;font-weight:700;flex-shrink:0;}
.notice-desc{font-size:14px;color:var(--sub);line-height:1.75;padding-left:30px;}
.notice-desc b{color:var(--text);}

.notice-guide{background:#f0f7ff;border:1px solid #bfdbfe;border-radius:8px;padding:16px 20px;margin:14px 0 18px 0;font-size:14px;color:var(--text);line-height:1.8;}
.notice-guide .guide-title{font-weight:700;font-size:14.5px;margin-bottom:6px;display:flex;align-items:center;gap:4px;}
.notice-guide .guide-ex{background:#fff;border:1px solid #dbeafe;border-radius:6px;padding:8px 14px;margin-top:8px;font-size:13.5px;color:var(--sub);line-height:1.6;}
.notice-guide .guide-ex b{color:var(--accent);}
.notice-task-rule{background:#fef9ee;border:1px solid #fde68a;border-radius:8px;padding:14px 18px;margin:10px 0 0 0;font-size:14px;color:var(--text);line-height:1.75;}
.notice-task-rule b{color:var(--orange);}

.notice-footer{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-top:14px;padding-top:14px;border-top:1px solid var(--border);}
.notice-contact{font-size:13px;color:var(--dim);}
.deadline{display:inline-block;background:#fef3c7;color:#92400e;padding:4px 14px;border-radius:6px;font-weight:700;font-size:13px;}

/* ===== íƒ­ ===== */
.tabs{display:flex;gap:0;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:20px;}
.tab{flex:1;padding:13px;text-align:center;font-size:14.5px;font-weight:500;cursor:pointer;border:none;background:none;color:var(--sub);transition:.15s;}
.tab:not(:last-child){border-right:1px solid var(--border);}
.tab.on{background:var(--accent);color:#fff;font-weight:600;}

/* ===== ì¹´ë“œ ===== */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:24px;margin-bottom:16px;}
.card-t{font-size:15px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.card-t svg{width:20px;height:20px;color:var(--accent);}

/* ì„ íƒ */
.sel-wrap{margin-bottom:16px;}
.sel-wrap label{font-size:13px;font-weight:600;color:var(--sub);display:block;margin-bottom:6px;}
.sel-wrap select,.sel-wrap input[type="text"]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;outline:none;background:var(--surface);color:var(--text);}
.sel-wrap select:focus,.sel-wrap input:focus{border-color:var(--accent);}

/* íŒ€ì› ë¦¬ìŠ¤íŠ¸ */
.member{border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:10px;background:#fafbfc;}
.member.is-lead{border-color:var(--accent);background:var(--accent-dim);}
.member-head{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.member-av{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#3b82f6);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;color:#fff;flex-shrink:0;}
.member-info{flex:1;}
.member-nm{font-size:14px;font-weight:700;}
.member-pos{font-size:11px;color:var(--sub);}
.member-badge{font-size:10px;font-weight:600;color:var(--accent);background:var(--accent-dim);padding:1px 8px;border-radius:10px;}
.task-rows{display:flex;flex-direction:column;gap:5px;}
.task-row{display:flex;align-items:center;gap:4px;}
.task-input{padding:7px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;outline:none;flex:1;transition:.15s;}
.task-input:focus{border-color:var(--accent);}
.btn-del-task{width:24px;height:24px;border:none;background:none;color:var(--dim);font-size:16px;cursor:pointer;border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.12s;}
.btn-del-task:hover{color:var(--red);background:rgba(220,38,38,.08);}
.btn-add-task{margin-top:4px;padding:3px 10px;background:none;border:1px dashed var(--border);border-radius:6px;color:var(--sub);font-size:11px;cursor:pointer;transition:.15s;}
.btn-add-task:hover{border-color:var(--accent);color:var(--accent);}

/* ì‚¬ì§„ â€” í˜„í™© */
.stat-bar{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;}
.stat-item{display:flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-size:14px;font-weight:600;}
.stat-total{background:var(--accent-dim);color:var(--accent);}
.stat-done{background:var(--green-dim);color:var(--green);}
.stat-remain{background:var(--orange-dim);color:var(--orange);}
.stat-item .stat-n{font-size:18px;font-weight:800;}
.progress-bar{height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden;margin-bottom:16px;}
.progress-bar .fill{height:100%;background:linear-gradient(90deg,var(--green),#22c55e);border-radius:3px;transition:width .4s ease;}

/* ì‚¬ì§„ â€” ì‚¬ëŒ ë¦¬ìŠ¤íŠ¸ */
.search-input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;outline:none;margin-bottom:12px;}
.search-input:focus{border-color:var(--accent);}
.person-list{max-height:400px;overflow-y:auto;}
.person-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:6px;cursor:pointer;transition:.12s;}
.person-item:hover{background:var(--accent-dim);border-color:var(--accent);}
.person-item.on{background:var(--green-dim);border-color:var(--green);}
.person-item .p-nm{font-weight:600;font-size:13px;}
.person-item .p-info{font-size:11px;color:var(--sub);}
.done-badge{display:inline-block;background:var(--green-dim);color:var(--green);padding:2px 10px;border-radius:10px;font-size:11px;font-weight:600;margin-left:auto;white-space:nowrap;}
.undone-badge{display:inline-block;background:var(--orange-dim);color:var(--orange);padding:2px 10px;border-radius:10px;font-size:11px;font-weight:600;margin-left:auto;white-space:nowrap;}

/* ì‚¬ì§„ ëª¨ë‹¬ */
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.45);z-index:500;align-items:center;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal{background:var(--surface);border-radius:14px;padding:32px;max-width:400px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.2);position:relative;animation:modalIn .2s ease;}
@keyframes modalIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.modal-close{position:absolute;top:12px;right:14px;background:none;border:none;font-size:20px;cursor:pointer;color:var(--dim);line-height:1;}
.modal-close:hover{color:var(--text);}
.modal .photo-circle{width:140px;height:140px;border-radius:50%;border:3px dashed var(--border);display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;transition:.15s;background:var(--bg);margin:0 auto 16px;}
.modal .photo-circle:hover{border-color:var(--accent);}
.modal .photo-circle.has-photo{border-style:solid;border-color:var(--green);}
.modal .photo-circle img{width:100%;height:100%;object-fit:cover;}
.modal .photo-circle svg{width:40px;height:40px;color:var(--dim);}
.modal-name{font-size:18px;font-weight:700;margin-bottom:4px;}
.modal-sub{font-size:12px;color:var(--sub);margin-bottom:18px;}
.modal-btns{display:flex;gap:8px;justify-content:center;margin-top:16px;}

/* ê´€ë¦¬ì ì˜ì—­ */
.admin-area{margin-top:16px;padding:16px;background:#fafbfc;border:1px solid var(--border);border-radius:8px;}
.admin-area summary{font-size:13px;font-weight:600;color:var(--sub);cursor:pointer;}
.admin-area summary:hover{color:var(--accent);}
.admin-lock{display:flex;align-items:center;gap:8px;margin-top:12px;}
.admin-lock input{width:120px;padding:7px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px;outline:none;text-align:center;letter-spacing:2px;}
.admin-lock input:focus{border-color:var(--accent);}
.admin-lock button{padding:7px 16px;font-size:12px;font-weight:600;}
.admin-lock .lock-msg{font-size:12px;color:var(--red);margin-left:4px;}
.admin-content{display:none;}
.admin-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}

/* ë²„íŠ¼ */
.btn{padding:10px 22px;border-radius:var(--radius);font-size:13px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text);transition:.15s;}
.btn:hover{background:var(--bg);}
.btn-p{background:var(--accent);color:#fff;border-color:var(--accent);}
.btn-p:hover{background:#2563eb;}
.btn-g{background:var(--green);color:#fff;border-color:var(--green);}
.btn-g:hover{background:#166534;}
.btn-sm{padding:7px 16px;font-size:12px;}
.btn-d{border-color:var(--red);color:var(--red);}.btn-d:hover{background:rgba(220,38,38,.06);}
.actions{display:flex;gap:8px;justify-content:center;margin-top:20px;}

.panel{display:none;}.panel.on{display:block;}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);background:#1E293B;color:#fff;padding:10px 24px;border-radius:8px;font-size:13px;opacity:0;transition:.3s;z-index:999;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.ok{background:var(--green);}.toast.err{background:var(--red);}

.empty-msg{text-align:center;padding:40px;color:var(--dim);font-size:14px;}
.save-status{text-align:center;margin-top:12px;font-size:13px;color:var(--green);font-weight:600;display:none;}
</style>
</head>
<body>

<div class="hd"><div class="hd-logo"><b>NETFORM</b> R&D ì§ì› ì •ë³´ ì œì¶œ</div></div>

<div class="wrap">
    <div class="notice">
        <h2><span class="notice-badge">ğŸ“¢ ê³µì§€</span> <span class="notice-title-text">ì§ì› ì •ë³´ ì‹œìŠ¤í…œ â€” ìë£Œ ìš”ì²­ ì•ˆë‚´</span></h2>
        <p class="notice-intro">ì§ì› ì •ë³´ ì‹œìŠ¤í…œ êµ¬ì¶•ì„ ìœ„í•´ ì•„ë˜ ìë£Œ ì œì¶œì„ ìš”ì²­ë“œë¦½ë‹ˆë‹¤.</p>

        <div class="notice-section">
            <div class="notice-section-title"><span class="num">1</span> ë‹´ë‹¹ì—…ë¬´ ê¸°ì¬ <span style="font-weight:400;color:var(--sub);font-size:13px;">(íŒ€ë³„ ë¦¬ë“œ)</span></div>
            <div class="notice-desc">
                ê° íŒ€ ë¦¬ë“œê»˜ì„œ <b>ë³¸ì¸ í¬í•¨ íŒ€ì›ë³„ ë‹´ë‹¹ì—…ë¬´</b>ë¥¼ ì‘ì„±í•˜ì—¬ ì œì¶œí•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.<br>
                ê¸°ì¬ëœ ë‹´ë‹¹ì—…ë¬´ëŠ” ì¶”í›„ <b>"ì´ ì—…ë¬´ëŠ” ëˆ„ê°€ ë‹´ë‹¹í•˜ëŠ”ì§€"</b>ë¥¼ ë¹ ë¥´ê²Œ í™•ì¸í•˜ê¸° ìœ„í•œ<br>
                <b>ê²€ìƒ‰ ì •ë³´</b>ë¡œ í™œìš©ë©ë‹ˆë‹¤.
            </div>
            <div class="notice-guide">
                <div class="guide-title">âœï¸ ê¸°ì¬ ë°©ë²•</div>
                Â· <b>ì—…ë¬´ í‚¤ì›Œë“œ + ì±„ë„ëª…</b> í˜•ì‹ìœ¼ë¡œ ê°„ë‹¨íˆ ê¸°ì¬í•´ ì£¼ì„¸ìš”.<br>
                Â· ë™ì¼ ì—…ë¬´ë¼ë„ <b>ì±„ë„ë³„ ë‹´ë‹¹ìê°€ ë‹¤ë¥¼ ê²½ìš° êµ¬ë¶„</b>í•˜ì—¬ ê¸°ì…í•´ ì£¼ì„¸ìš”.
                <div class="guide-ex">
                    ì˜ˆ) <b>ìƒì‚°ê´€ë¦¬</b>, <b>ì½˜í…ì¸  ê¸°íš(ë„·í¼)</b>, <b>ì½˜í…ì¸  ê¸°íš(POURê³µë²•)</b>
                </div>
            </div>
            <div class="notice-task-rule">
                ğŸ“Œ ì—…ë¬´ <b>1, 2ë²ˆì€ ì£¼ì—…ë¬´</b>ë¡œ ë“±ë¡ë©ë‹ˆë‹¤. ê°€ì¥ ì¤‘ìš”í•œ ì—…ë¬´ë¥¼ 1, 2ë²ˆì— ê¸°ì…í•´ ì£¼ì„¸ìš”.<br>
                Â· 3ë²ˆë¶€í„°ëŠ” ë¶€ìˆ˜ ì—…ë¬´ë¡œ ë¶„ë¥˜ë©ë‹ˆë‹¤. í•„ìš” ì‹œ <b>"ì—…ë¬´ ì¶”ê°€"</b> ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>
        </div>

        <div class="notice-section">
            <div class="notice-section-title"><span class="num">2</span> ì¦ëª…ì‚¬ì§„ ì œì¶œ <span style="font-weight:400;color:var(--sub);font-size:13px;">(ê°œì¸ë³„)</span></div>
            <div class="notice-desc">
                ë³¸ì¸ ì´ë¦„ì„ ì„ íƒ í›„ ì¦ëª…ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.<br>
                ì—…ë¡œë“œëœ ì‚¬ì§„ì€ ìë™ ì €ì¥ë˜ë©°, ë³„ë„ íŒŒì¼ ì „ë‹¬ ì—†ì´ ê´€ë¦¬ìê°€ ì¼ê´„ í™•ì¸í•©ë‹ˆë‹¤.
            </div>
        </div>

        <div class="notice-footer">
            <span class="notice-contact">â€» ë¬¸ì˜: ê²½ì˜ê´€ë¦¬íŒ€ ê¹€ìœ ë¦¼ ë§¤ë‹ˆì €</span>
            <span class="deadline">ğŸ“… ì œì¶œ ê¸°í•œ: 2025ë…„ 2ì›” 13ì¼(ëª©)</span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab on" onclick="switchTab('task')">ğŸ“‹ ë‹´ë‹¹ì—…ë¬´ ì…ë ¥ (ë¦¬ë“œìš©)</div>
        <div class="tab" onclick="switchTab('photo')">ğŸ“· ì¦ëª…ì‚¬ì§„ ì—…ë¡œë“œ (ê°œì¸)</div>
    </div>

    <!-- ëª¨ë“œ1: ë‹´ë‹¹ì—…ë¬´ -->
    <div class="panel on" id="pTask">
        <div class="card">
            <div class="card-t"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> ë¦¬ë“œ ì„ íƒ</div>
            <div class="sel-wrap">
                <label>ë³¸ì¸ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</label>
                <select id="leadSel" onchange="selectLead()">
                    <option value="">-- ë¦¬ë“œ ì„ íƒ --</option>
                </select>
            </div>
        </div>
        <div id="teamArea"></div>
        <div class="actions" id="taskActions" style="display:none">
            <button class="btn btn-g" onclick="saveTaskData()">ğŸ’¾ ì €ì¥</button>
        </div>
        <div class="save-status" id="taskSaveStatus"></div>
        <div id="taskDlArea" style="display:none;margin-top:12px;">
            <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
                <button class="btn btn-sm btn-p" onclick="dlTaskJSON()">ğŸ“¥ JSON ë‹¤ìš´ë¡œë“œ <span style="font-size:10px;opacity:.7;">(HTML ì„í¬íŠ¸ìš©)</span></button>
                <button class="btn btn-sm" onclick="dlTaskCSV()">ğŸ“Š ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ <span style="font-size:10px;opacity:.7;">(ê´€ë¦¬ìš©)</span></button>
            </div>
        </div>
    </div>

    <!-- ëª¨ë“œ2: ì‚¬ì§„ -->
    <div class="panel" id="pPhoto">
        <div class="card">
            <div class="card-t"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg> ì¦ëª…ì‚¬ì§„ ì—…ë¡œë“œ</div>
            <div id="photoStatArea"></div>
            <input type="text" class="search-input" id="photoSearch" placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." oninput="filterPhotoList()">
            <div class="person-list" id="photoList"></div>
            <!-- ê´€ë¦¬ì ì˜ì—­ -->
            <details class="admin-area">
                <summary>ğŸ”§ ê´€ë¦¬ì ë„êµ¬</summary>
                <div class="admin-lock" id="adminLock">
                    <input type="password" id="adminPwInput" placeholder="ë¹„ë°€ë²ˆí˜¸" maxlength="10" onkeydown="if(event.key==='Enter')unlockAdmin()">
                    <button class="btn btn-sm btn-p" onclick="unlockAdmin()">ğŸ”“ í™•ì¸</button>
                    <span class="lock-msg" id="lockMsg"></span>
                </div>
                <div class="admin-content" id="adminContent">
                <p style="font-size:12px;color:var(--sub);margin:10px 0 6px;line-height:1.6;">
                    <b>ğŸ“· ì‚¬ì§„ ë°ì´í„°</b>
                </p>
                <div class="admin-btns">
                    <button class="btn btn-sm btn-p" onclick="downloadAllPhotos()">ğŸ“¥ ì‚¬ì§„ JSON ë‹¤ìš´ë¡œë“œ <span style="font-size:10px;opacity:.7;">(HTML ì„í¬íŠ¸ìš©)</span></button>
                    <button class="btn btn-sm" onclick="downloadPhotoStatus()">ğŸ“Š ì‚¬ì§„ ì œì¶œí˜„í™© CSV</button>
                </div>
                <p style="font-size:12px;color:var(--sub);margin:14px 0 6px;line-height:1.6;">
                    <b>ğŸ“‹ ë‹´ë‹¹ì—…ë¬´ ë°ì´í„° (ì „ì²´ ì·¨í•©)</b>
                </p>
                <div class="admin-btns">
                    <button class="btn btn-sm btn-p" onclick="downloadAllTasksJSON()">ğŸ“¥ ì—…ë¬´ ì „ì²´ JSON ë‹¤ìš´ë¡œë“œ <span style="font-size:10px;opacity:.7;">(HTML ì„í¬íŠ¸ìš©)</span></button>
                    <button class="btn btn-sm" onclick="downloadAllTasksCSV()">ğŸ“Š ì—…ë¬´ ì „ì²´ CSV ë‹¤ìš´ë¡œë“œ <span style="font-size:10px;opacity:.7;">(ì—‘ì…€ìš©)</span></button>
                </div>
                <p style="font-size:12px;color:var(--sub);margin:14px 0 6px;line-height:1.6;">
                    <b>ğŸ“¦ ì „ì²´ í†µí•© (ì—…ë¬´ + ì‚¬ì§„)</b>
                </p>
                <div class="admin-btns">
                    <button class="btn btn-sm btn-g" onclick="downloadAllMergedJSON()">ğŸ“¥ í†µí•© JSON ë‹¤ìš´ë¡œë“œ <span style="font-size:10px;opacity:.7;">(ì§ì›ì •ë³´ê³µìœ .html â†’ JSON íŒŒì¼ ë³‘í•©)</span></button>
                </div>
                <div id="n8nAdminArea" style="display:none">
                    <p style="font-size:12px;color:var(--sub);margin:14px 0 6px;line-height:1.6;">
                        <b>â˜ï¸ n8n ì„œë²„ ë°ì´í„°</b> <span style="font-size:11px;color:var(--dim);">(ëª¨ë“  PCì—ì„œ ì·¨í•©ëœ ë°ì´í„°)</span>
                    </p>
                    <div class="admin-btns">
                        <button class="btn btn-sm btn-p" onclick="fetchN8nData('status')">ğŸ“Š ì œì¶œ í˜„í™© í™•ì¸</button>
                        <button class="btn btn-sm btn-g" onclick="fetchN8nData('all')">ğŸ“¥ ì„œë²„ í†µí•© JSON ë‹¤ìš´ë¡œë“œ</button>
                        <button class="btn btn-sm" onclick="fetchN8nData('tasks')">ğŸ“‹ ì„œë²„ ì—…ë¬´ JSON</button>
                        <button class="btn btn-sm" onclick="fetchN8nData('photos')">ğŸ“· ì„œë²„ ì‚¬ì§„ JSON</button>
                    </div>
                    <div id="n8nResult" style="margin-top:10px;"></div>
                </div>
                </div><!-- /admin-content -->
            </details>
        </div>
    </div>
</div>

<!-- ì‚¬ì§„ ì—…ë¡œë“œ ëª¨ë‹¬ -->
<div class="modal-overlay" id="photoModal">
    <div class="modal">
        <button class="modal-close" onclick="closePhotoModal()">&times;</button>
        <div class="photo-circle" id="modalPreview" onclick="document.getElementById('photoFile').click()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
        </div>
        <div class="modal-name" id="modalName"></div>
        <div class="modal-sub" id="modalSub"></div>
        <p style="font-size:12px;color:var(--dim);margin-bottom:6px;">ì¦ëª…ì‚¬ì§„ ê¶Œì¥ (ì •ë©´, ë°ì€ ë°°ê²½)<br>í´ë¦­í•˜ì—¬ ì‚¬ì§„ì„ ì„ íƒí•˜ì„¸ìš”</p>
        <input type="file" id="photoFile" accept="image/*" style="display:none" onchange="handleUserPhoto(event)">
        <div class="modal-btns">
            <button class="btn btn-sm" onclick="document.getElementById('photoFile').click()">ğŸ“ ì‚¬ì§„ ì„ íƒ</button>
            <button class="btn btn-sm btn-d" id="modalDelBtn" style="display:none" onclick="clearUserPhoto()">ğŸ—‘ ì‚­ì œ</button>
        </div>
        <div class="modal-btns" style="margin-top:10px;">
            <button class="btn btn-sm btn-g" id="modalSaveBtn" onclick="savePhotoData()">ğŸ’¾ ì €ì¥</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== ì„¤ì • =====
const STORE_KEY='nf_submit_v1';
// n8n Webhook URL (ì„¤ì •í•˜ë©´ ì €ì¥ ì‹œ ìë™ ì „ì†¡, ë¹„ì›Œë‘ë©´ localStorageë§Œ ì‚¬ìš©)
const WEBHOOK_URL='https://nfrnd.app.n8n.cloud/webhook/emp-submit';
const ADMIN_URL='';    // ì˜ˆ: 'https://nfrnd.app.n8n.cloud/webhook/emp-admin'

function getStore(){try{return JSON.parse(localStorage.getItem(STORE_KEY))||{};}catch(e){return {};}}
function setStore(d){localStorage.setItem(STORE_KEY,JSON.stringify(d));}

// n8n Webhook ì „ì†¡ (ë°±ê·¸ë¼ìš´ë“œ, ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
function sendToWebhook(type, records, submitter){
    if(!WEBHOOK_URL) return;
    try{
        fetch(WEBHOOK_URL,{
            method:'POST',
            headers:{'Content-Type':'text/plain'},
            body:JSON.stringify({type, records, submitter, timestamp:new Date().toISOString()})
        }).then(r=>{
            console.log('[n8n] ì „ì†¡ ì™„ë£Œ');
        }).catch(e=>console.warn('[n8n] ì „ì†¡ ì‹¤íŒ¨ (ë¡œì»¬ ì €ì¥ì€ ì™„ë£Œ):', e));
    }catch(e){}
}

// ===== ì§ì› ë°ì´í„° (ã„±ã„´ã„·ìˆœ) =====
const EMP=[
    {name:'ê¶Œì •ì•„',division:'ì˜ì—…ë³¸ë¶€',team:'ì„œë¹„ìŠ¤ìš´ì˜2íŒ€',position:'ë¦¬ë“œ ë§¤ë‹ˆì €'},
    {name:'ê¶Œí˜œì˜',division:'ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€',team:'ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€',position:'ë¦¬ë“œ ë§¤ë‹ˆì €'},
    {name:'ê¹€ê²½ë¯¸',division:'ì˜ì—…ë³¸ë¶€',team:'ì„œë¹„ìŠ¤ìš´ì˜1íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ê¹€ë¯¼ì§€',division:'ì»¤ë¨¸ìŠ¤ì‚¬ì—…ë³¸ë¶€',team:'ë¸Œëœë“œì»¤ë¨¸ìŠ¤íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ê¹€ë²”ì„',division:'ê²½ì˜ê´€ë¦¬ë³¸ë¶€',team:'ê·¸ë¡œìŠ¤íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ê¹€ì„±ë¯¼',division:'ì˜ì—…ë³¸ë¶€',team:'ì„œë¹„ìŠ¤ìš´ì˜1íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ê¹€ì„±ì¤€',division:'ìš©ì¸ì‚¬ì—…ì¥',team:'ìš©ì¸ê³µì¥',position:'ê³µì¥ì¥'},
    {name:'ê¹€ì†Œë¼',division:'ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€',team:'ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ê¹€ì†Œì—°',division:'ì»¤ë¨¸ìŠ¤ì‚¬ì—…ë³¸ë¶€',team:'ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ê¹€ì†Œì •',division:'ìš©ì¸ì‚¬ì—…ì¥',team:'ê±´ì„¤ ê¸°ìˆ ì—°êµ¬ì†Œ',position:'ì—°êµ¬ì›'},
    {name:'ê¹€ì†¡í¬',division:'ì»¤ë¨¸ìŠ¤ì‚¬ì—…ë³¸ë¶€',team:'ëª¨ì—¬ë¼ë”œíŒ€',position:'ë¦¬ë“œ ë§¤ë‹ˆì €'},
    {name:'ê¹€ìˆ˜ì§„',division:'ì˜ì—…ë³¸ë¶€',team:'ì„œë¹„ìŠ¤ìš´ì˜2íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ê¹€ìœ ë¦¼',division:'ê²½ì˜ê´€ë¦¬ë³¸ë¶€',team:'ê²½ì˜ê´€ë¦¬íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ê¹€ìœ ì§„',division:'ìš©ì¸ì‚¬ì—…ì¥',team:'ìƒì‚°/í’ˆì§ˆê´€ë¦¬íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ê¹€ì±„ì›',division:'ì»¤ë¨¸ìŠ¤ì‚¬ì—…ë³¸ë¶€',team:'í•´ì™¸ì‚¬ì—…íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ë‚¨ìœ¤ì •',division:'ì»¤ë¨¸ìŠ¤ì‚¬ì—…ë³¸ë¶€',team:'ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ë°±ì •ì„',division:'ê²½ì˜ê´€ë¦¬ë³¸ë¶€',team:'ê²½ì˜ê´€ë¦¬ë³¸ë¶€',position:'ì´ì‚¬'},
    {name:'ì†ì˜ˆì§„',division:'ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€',team:'ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì†¡ë³´ëŒ',division:'ì˜ì—…ë³¸ë¶€',team:'ì„œë¹„ìŠ¤ìš´ì˜3íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì‹ ë‚˜ì˜',division:'ê²½ì˜ê´€ë¦¬ë³¸ë¶€',team:'ê²½ì˜ê´€ë¦¬íŒ€',position:'ë¦¬ë“œ ë§¤ë‹ˆì €'},
    {name:'ì‹ ëª…í¬',division:'ìš©ì¸ì‚¬ì—…ì¥',team:'ì†Œì¬ ê¸°ìˆ ì—°êµ¬ì†Œ',position:'ì„ ì„ì—°êµ¬ì›'},
    {name:'ì‹¬í˜œì§„',division:'ìš©ì¸ì‚¬ì—…ì¥',team:'ê±´ì„¤ ê¸°ìˆ ì—°êµ¬ì†Œ',position:'ì—°êµ¬ì›'},
    {name:'ì´ë‚˜ë¼',division:'ìš©ì¸ì‚¬ì—…ì¥',team:'ê´€ë¦¬íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì´ë€',division:'ì»¤ë¨¸ìŠ¤ì‚¬ì—…ë³¸ë¶€',team:'ë¸Œëœë“œì»¤ë¨¸ìŠ¤íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì´ìŠ¹ìš°',division:'ê²½ì˜ì´ê´„',team:'ê²½ì˜ì´ê´„',position:'ëŒ€í‘œì´ì‚¬'},
    {name:'ì´ì¬ë¯¼',division:'ìš©ì¸ì‚¬ì—…ì¥',team:'ìƒì‚°/í’ˆì§ˆê´€ë¦¬íŒ€',position:'ë¦¬ë“œ ë§¤ë‹ˆì €'},
    {name:'ì´ì¬í›ˆ',division:'ê²½ì˜ê´€ë¦¬ë³¸ë¶€',team:'ê·¸ë¡œìŠ¤íŒ€',position:'ë¦¬ë“œ ë§¤ë‹ˆì €'},
    {name:'ì´ì •í›ˆ',division:'ìš©ì¸ì‚¬ì—…ì¥',team:'ê±´ì„¤ ê¸°ìˆ ì—°êµ¬ì†Œ',position:'ê¸°ìˆ ì—°êµ¬ì†Œì¥'},
    {name:'ì´ì§€ì—°',division:'ì˜ì—…ë³¸ë¶€',team:'ì„œë¹„ìŠ¤ìš´ì˜2íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì´ì±„ì€',division:'ì»¤ë¨¸ìŠ¤ì‚¬ì—…ë³¸ë¶€',team:'ëª¨ì—¬ë¼ë”œíŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì´í•„ì„ ',division:'ì˜ì—…ë³¸ë¶€',team:'ì˜ì—…íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì •ì˜ì¬',division:'ìš©ì¸ì‚¬ì—…ì¥',team:'ìš©ì¸ì‚¬ì—…ì¥',position:'ë¶€ì‚¬ì¥'},
    {name:'ì •ì •í›ˆ',division:'ì˜ì—…ë³¸ë¶€',team:'ì„œë¹„ìŠ¤ìš´ì˜1íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì •íƒœìœ¤',division:'ì˜ì—…ë³¸ë¶€',team:'ì„¤ê³„/ì ì‚°íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì¡°ì¬ì—°',division:'ì˜ì—…ë³¸ë¶€',team:'ì„œë¹„ìŠ¤ìš´ì˜1íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì£¼ìœ ì§„',division:'ê²½ì˜ê´€ë¦¬ë³¸ë¶€',team:'ê²½ì˜ê´€ë¦¬íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ì£¼í˜„ì§„',division:'ì˜ì—…ë³¸ë¶€',team:'ì„œë¹„ìŠ¤ìš´ì˜3íŒ€',position:'ë¦¬ë“œ ë§¤ë‹ˆì €'},
    {name:'ì©í‹°ë¦¬',division:'ì»¤ë¨¸ìŠ¤ì‚¬ì—…ë³¸ë¶€',team:'í•´ì™¸ì‚¬ì—…íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ìµœê²½ì„ ',division:'ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€',team:'ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'ìµœì˜ì˜¥',division:'ê²½ì˜ê´€ë¦¬ë³¸ë¶€',team:'ê²½ì˜ê´€ë¦¬íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'í•œì¸ê·œ',division:'ì˜ì—…ë³¸ë¶€',team:'ì„¤ê³„/ì ì‚°íŒ€',position:'ë¦¬ë“œ ë§¤ë‹ˆì €'},
    {name:'í•œì¤€ì—½',division:'ì˜ì—…ë³¸ë¶€',team:'ì„œë¹„ìŠ¤ìš´ì˜1íŒ€',position:'ë¦¬ë“œ ë§¤ë‹ˆì €'},
    {name:'í•¨ì§€ë¯¼',division:'ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€',team:'ë¸Œëœë“œë§ˆì¼€íŒ…íŒ€',position:'ë§¤ë‹ˆì €'},
    {name:'í™©ìœ¤ì„ ',division:'ì˜ì—…ë³¸ë¶€',team:'ì˜ì—…ë³¸ë¶€',position:'ìƒë¬´ì´ì‚¬'},
];

// ===== ë¦¬ë“œ ì„¤ì • =====
// ë¦¬ë“œì—ì„œ ì œì™¸í•  ì‚¬ëŒ (ì„ì› + ì´ì •í›ˆ ì—°êµ¬ì†Œì¥)
const EXCLUDE_LEAD=['ì´ìŠ¹ìš°','í™©ìœ¤ì„ ','ì •ì˜ì¬','ë°±ì •ì„','ì´ì •í›ˆ'];
const LEAD_POS=['ë¦¬ë“œ ë§¤ë‹ˆì €','ê³µì¥ì¥','ì„ ì„ì—°êµ¬ì›'];
// ë¦¬ë“œê°€ ì—†ëŠ” íŒ€ â†’ ì·¨í•© ë‹´ë‹¹ì ìˆ˜ë™ ì§€ì •
const TEAM_LEAD_OVERRIDE={
    'í•´ì™¸ì‚¬ì—…íŒ€':'ê¹€ì±„ì›|í•´ì™¸ì‚¬ì—…íŒ€',
    'ë¸Œëœë“œì»¤ë¨¸ìŠ¤íŒ€':'ì´ë€|ë¸Œëœë“œì»¤ë¨¸ìŠ¤íŒ€',
    'ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤íŒ€':'ê¹€ì†Œì—°|ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤íŒ€',
    'ì˜ì—…íŒ€':'ì´í•„ì„ |ì˜ì—…íŒ€',
};
const OVERRIDE_EXCLUDE=['ì´ì¬í›ˆ|ë¯¸ë””ì–´ì»¤ë¨¸ìŠ¤íŒ€'];
const FACTORY_MANAGED=['ê´€ë¦¬íŒ€','ìƒì‚°/í’ˆì§ˆê´€ë¦¬íŒ€'];

// ì‹ ëª…í¬(ì†Œì¬ ê¸°ìˆ ì—°êµ¬ì†Œ)ê°€ ê±´ì„¤ ê¸°ìˆ ì—°êµ¬ì†Œ ì—°êµ¬ì›(ì‹¬í˜œì§„, ê¹€ì†Œì •)ë„ í•¨ê»˜ ì…ë ¥
const RESEARCH_EXTRA={'ì‹ ëª…í¬|ì†Œì¬ ê¸°ìˆ ì—°êµ¬ì†Œ':['ì‹¬í˜œì§„|ê±´ì„¤ ê¸°ìˆ ì—°êµ¬ì†Œ','ê¹€ì†Œì •|ê±´ì„¤ ê¸°ìˆ ì—°êµ¬ì†Œ']};

const leads=EMP.filter(e=>{
    if(EXCLUDE_LEAD.includes(e.name)) return false;
    if(FACTORY_MANAGED.includes(e.team)) return false;
    if(OVERRIDE_EXCLUDE.includes(e.name+'|'+e.team)) return false;
    if(LEAD_POS.includes(e.position)) return true;
    const ov=TEAM_LEAD_OVERRIDE[e.team];
    if(ov&&ov===e.name+'|'+e.team) return true;
    return false;
});

// íƒ­ ì „í™˜
function switchTab(t){
    document.querySelectorAll('.tab').forEach((b,i)=>b.classList.toggle('on',i===(t==='task'?0:1)));
    document.getElementById('pTask').className='panel'+(t==='task'?' on':'');
    document.getElementById('pPhoto').className='panel'+(t==='photo'?' on':'');
    if(t==='photo') renderPhotoStat();
}

// ===== ëª¨ë“œ1: ë‹´ë‹¹ì—…ë¬´ =====
function initLeadSel(){
    const sel=document.getElementById('leadSel');
    leads.forEach(l=>{
        const o=document.createElement('option');
        o.value=l.name+'|'+l.team;
        const label=`${l.name} (${l.team} Â· ${l.position})`;
        sel.appendChild(o);
        o.textContent=label;
    });
}

let curLead=null;
let allMembers=[];
function selectLead(){
    const v=document.getElementById('leadSel').value;
    if(!v){document.getElementById('teamArea').innerHTML='';document.getElementById('taskActions').style.display='none';document.getElementById('taskSaveStatus').style.display='none';curLead=null;return;}
    const [name,team]=v.split('|');
    curLead={name,team};
    const lead=EMP.find(e=>e.name===name&&e.team===team)||EMP.find(e=>e.name===name);

    const FACTORY_TEAMS=['ìš©ì¸ê³µì¥','ê´€ë¦¬íŒ€','ìƒì‚°/í’ˆì§ˆê´€ë¦¬íŒ€'];
    let teamMembers;
    if(lead.position==='ê³µì¥ì¥'){
        teamMembers=EMP.filter(e=>FACTORY_TEAMS.includes(e.team)&&e.name!==name);
    } else {
        teamMembers=EMP.filter(e=>e.team===team&&e.name!==name);
    }

    // ì‹ ëª…í¬ ì„ íƒ ì‹œ ê±´ì„¤ê¸°ìˆ ì—°êµ¬ì†Œ ì—°êµ¬ì›ë„ í¬í•¨
    const extraKey=name+'|'+team;
    if(RESEARCH_EXTRA[extraKey]){
        RESEARCH_EXTRA[extraKey].forEach(key=>{
            const [eName,eTeam]=key.split('|');
            const emp=EMP.find(e=>e.name===eName&&e.team===eTeam);
            if(emp&&!teamMembers.includes(emp)) teamMembers.push(emp);
        });
    }

    allMembers=[lead,...teamMembers];
    renderTeamMembers(allMembers);
    document.getElementById('taskActions').style.display='flex';
    document.getElementById('taskSaveStatus').style.display='none';
}

function renderTeamMembers(members){
    const area=document.getElementById('teamArea');
    if(!members.length){area.innerHTML='<div class="empty-msg">í•´ë‹¹ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
    const store=getStore();
    area.innerHTML=members.map((m,i)=>{
        const storeKey=m.name+'|'+m.team;
        const saved=store['task_'+storeKey];
        const tasks=saved||[];
        const rows=Math.max(2,tasks.length);
        const isLead=(i===0);
        let inputs='';
        for(let j=0;j<rows;j++){
            inputs+=`<div class="task-row"><input class="task-input" data-member="${i}" placeholder="ì—…ë¬´ ${j+1}" value="${tasks[j]||''}"><button class="btn-del-task" onclick="delRow(this)" title="ì‚­ì œ">&times;</button></div>`;
        }
        return `<div class="member${isLead?' is-lead':''}" data-idx="${i}">
            <div class="member-head">
                <div class="member-av">${m.name[0]}</div>
                <div class="member-info"><div class="member-nm">${m.name}${isLead?' <span class="member-badge">ë³¸ì¸</span>':''}</div><div class="member-pos">${m.position} Â· ${m.team}</div></div>
            </div>
            <div class="task-rows" id="taskRows${i}">${inputs}</div>
            <button class="btn-add-task" onclick="addRow(${i})">+ ì—…ë¬´ ì¶”ê°€</button>
        </div>`;
    }).join('');
}

function addRow(idx){
    const rows=document.getElementById('taskRows'+idx);
    const n=rows.querySelectorAll('.task-input').length+1;
    const div=document.createElement('div');
    div.className='task-row';
    div.innerHTML=`<input class="task-input" data-member="${idx}" placeholder="ì—…ë¬´ ${n}"><button class="btn-del-task" onclick="delRow(this)" title="ì‚­ì œ">&times;</button>`;
    rows.appendChild(div);
    div.querySelector('.task-input').focus();
}

function delRow(btn){
    const row=btn.closest('.task-row');
    const rows=row.parentElement;
    if(rows.querySelectorAll('.task-row').length<=1){
        row.querySelector('.task-input').value='';
        return;
    }
    row.remove();
    rows.querySelectorAll('.task-input').forEach((inp,j)=>{inp.placeholder='ì—…ë¬´ '+(j+1);});
}

function saveTaskData(){
    if(!allMembers||!allMembers.length){toast('íŒ€ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.','err');return;}
    const store=getStore();
    let count=0;
    allMembers.forEach((m,i)=>{
        const inputs=[...document.getElementById('taskRows'+i).querySelectorAll('.task-input')];
        const tasks=inputs.map(inp=>inp.value.trim()).filter(Boolean);
        if(tasks.length){
            store['task_'+m.name+'|'+m.team]=tasks;
            count++;
        }
    });
    setStore(store);
    // n8n Webhook ì „ì†¡
    const webhookRecords=allMembers.map((m,i)=>{
        const inputs=[...document.getElementById('taskRows'+i).querySelectorAll('.task-input')];
        const tasks=inputs.map(inp=>inp.value.trim()).filter(Boolean);
        return {name:m.name,division:m.division,team:m.team,position:m.position,primaryTasks:tasks};
    }).filter(d=>d.primaryTasks.length);
    if(webhookRecords.length) sendToWebhook('task',webhookRecords,curLead.name);
    const status=document.getElementById('taskSaveStatus');
    status.textContent=`âœ… ${count}ëª… ë‹´ë‹¹ì—…ë¬´ ì €ì¥ ì™„ë£Œ (${new Date().toLocaleTimeString()})`;
    status.style.display='block';
    document.getElementById('taskDlArea').style.display='block';
    toast(`${count}ëª… ë‹´ë‹¹ì—…ë¬´ ì €ì¥ ì™„ë£Œ!`,'ok');
}

// í˜„ì¬ ì„ íƒëœ íŒ€ ë‹´ë‹¹ì—…ë¬´ JSON ë‹¤ìš´ë¡œë“œ (HTML ì„í¬íŠ¸ìš©)
function dlTaskJSON(){
    if(!allMembers||!allMembers.length){toast('ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.','err');return;}
    const result=allMembers.map((m,i)=>{
        const inputs=[...document.getElementById('taskRows'+i).querySelectorAll('.task-input')];
        const tasks=inputs.map(inp=>inp.value.trim()).filter(Boolean);
        return {name:m.name,division:m.division,team:m.team,position:m.position,primaryTasks:tasks};
    }).filter(d=>d.primaryTasks.length);
    if(!result.length){toast('ì…ë ¥ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.','err');return;}
    downloadJSON(result,`ë‹´ë‹¹ì—…ë¬´_${curLead.team}_${curLead.name}`);
    toast('JSON ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! â†’ ì§ì›ì •ë³´ê³µìœ .htmlì—ì„œ "JSON íŒŒì¼ ë³‘í•©"ìœ¼ë¡œ ì„í¬íŠ¸','ok');
}

// í˜„ì¬ ì„ íƒëœ íŒ€ ë‹´ë‹¹ì—…ë¬´ CSV ë‹¤ìš´ë¡œë“œ (ì—‘ì…€ìš©)
function dlTaskCSV(){
    if(!allMembers||!allMembers.length){toast('ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.','err');return;}
    const rows=[['ì´ë¦„','ë³¸ë¶€','íŒ€','ì§ê¸‰','ì£¼ì—…ë¬´1','ì£¼ì—…ë¬´2','ì—…ë¬´3','ì—…ë¬´4','ì—…ë¬´5']];
    allMembers.forEach((m,i)=>{
        const inputs=[...document.getElementById('taskRows'+i).querySelectorAll('.task-input')];
        const tasks=inputs.map(inp=>inp.value.trim()).filter(Boolean);
        if(tasks.length){
            const row=[m.name,m.division,m.team,m.position];
            for(let j=0;j<5;j++) row.push(tasks[j]||'');
            rows.push(row);
        }
    });
    if(rows.length<=1){toast('ì…ë ¥ëœ ì—…ë¬´ê°€ ì—†ìŠµë‹ˆë‹¤.','err');return;}
    downloadCSV(rows,`ë‹´ë‹¹ì—…ë¬´_${curLead.team}_${curLead.name}`);
    toast('ì—‘ì…€(CSV) ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!','ok');
}

// ===== ëª¨ë“œ2: ì‚¬ì§„ =====
let photoTarget=null,photoData='';

function getPhotoStats(){
    const store=getStore();
    let done=0;
    EMP.forEach(e=>{if(store['photo_'+e.name+'|'+e.team]) done++;});
    return {total:EMP.length, done, remain:EMP.length-done};
}

function renderPhotoStat(){
    const s=getPhotoStats();
    const pct=s.total?Math.round(s.done/s.total*100):0;
    document.getElementById('photoStatArea').innerHTML=`
        <div class="stat-bar">
            <div class="stat-item stat-total">ì „ì²´ <span class="stat-n">${s.total}</span>ëª…</div>
            <div class="stat-item stat-done">ì™„ë£Œ <span class="stat-n">${s.done}</span>ëª…</div>
            <div class="stat-item stat-remain">ë¯¸ì™„ë£Œ <span class="stat-n">${s.remain}</span>ëª…</div>
        </div>
        <div class="progress-bar"><div class="fill" style="width:${pct}%"></div></div>`;
}

function initPhotoList(){renderPhotoStat();renderPhotoList('');}
function filterPhotoList(){renderPhotoList(document.getElementById('photoSearch').value.trim());}

function renderPhotoList(q){
    const list=document.getElementById('photoList');
    const filtered=q?EMP.filter(e=>e.name.includes(q)):EMP;
    const store=getStore();
    list.innerHTML=filtered.map(e=>{
        const idx=EMP.indexOf(e);
        const hasPhoto=store['photo_'+e.name+'|'+e.team];
        return `<div class="person-item${hasPhoto?' on':''}" onclick="openPhotoModal(${idx})">
        <div class="member-av" style="width:30px;height:30px;font-size:11px;">${e.name[0]}</div>
        <div><div class="p-nm">${e.name}</div><div class="p-info">${e.team} Â· ${e.position}</div></div>
        ${hasPhoto?'<span class="done-badge">âœ… ë“±ë¡ì™„ë£Œ</span>':'<span class="undone-badge">ë¯¸ë“±ë¡</span>'}
    </div>`;
    }).join('');
}

function openPhotoModal(idx){
    const e=EMP[idx];if(!e)return;
    photoTarget=e;photoData='';
    const store=getStore();
    const saved=store['photo_'+e.name+'|'+e.team];
    document.getElementById('modalName').textContent=e.name;
    document.getElementById('modalSub').textContent=`${e.team} Â· ${e.position}`;
    const preview=document.getElementById('modalPreview');
    if(saved){
        photoData=saved;
        preview.innerHTML=`<img src="${saved}">`;
        preview.classList.add('has-photo');
        document.getElementById('modalDelBtn').style.display='inline-flex';
    } else {
        preview.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>';
        preview.classList.remove('has-photo');
        document.getElementById('modalDelBtn').style.display='none';
    }
    document.getElementById('photoFile').value='';
    document.getElementById('photoModal').classList.add('show');
}

function closePhotoModal(){
    document.getElementById('photoModal').classList.remove('show');
    photoTarget=null;photoData='';
}

function handleUserPhoto(ev){
    const file=ev.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(e){
        const img=new Image();
        img.onload=function(){
            const max=300,c=document.createElement('canvas');
            let w=img.width,h=img.height;
            if(w>h){if(w>max){h=h*max/w;w=max;}}else{if(h>max){w=w*max/h;h=max;}}
            c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
            photoData=c.toDataURL('image/jpeg',0.8);
            const preview=document.getElementById('modalPreview');
            preview.innerHTML=`<img src="${photoData}">`;
            preview.classList.add('has-photo');
            document.getElementById('modalDelBtn').style.display='inline-flex';
        };
        img.src=e.target.result;
    };
    reader.readAsDataURL(file);
}

function clearUserPhoto(){
    photoData='';
    document.getElementById('photoFile').value='';
    const preview=document.getElementById('modalPreview');
    preview.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>';
    preview.classList.remove('has-photo');
    document.getElementById('modalDelBtn').style.display='none';
    if(photoTarget){
        const store=getStore();
        delete store['photo_'+photoTarget.name+'|'+photoTarget.team];
        setStore(store);
        renderPhotoStat();
        renderPhotoList(document.getElementById('photoSearch').value.trim());
        toast('ì‚¬ì§„ ì‚­ì œ ì™„ë£Œ','ok');
    }
}

function savePhotoData(){
    if(!photoTarget){toast('ì„ íƒëœ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.','err');return;}
    if(!photoData){toast('ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.','err');return;}
    const store=getStore();
    store['photo_'+photoTarget.name+'|'+photoTarget.team]=photoData;
    setStore(store);
    // n8n Webhook ì „ì†¡
    sendToWebhook('photo',[{name:photoTarget.name,division:photoTarget.division,team:photoTarget.team,position:photoTarget.position,photo:photoData}],photoTarget.name);
    toast(`${photoTarget.name} ì‚¬ì§„ ì €ì¥ ì™„ë£Œ!`,'ok');
    closePhotoModal();
    renderPhotoStat();
    renderPhotoList(document.getElementById('photoSearch').value.trim());
}

// ===== ê´€ë¦¬ì ë„êµ¬ =====
const ADMIN_PW='1212';
function unlockAdmin(){
    const inp=document.getElementById('adminPwInput');
    const msg=document.getElementById('lockMsg');
    if(inp.value===ADMIN_PW){
        document.getElementById('adminLock').style.display='none';
        document.getElementById('adminContent').style.display='block';
        msg.textContent='';
    }else{
        msg.textContent='ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
        inp.value='';
        inp.focus();
        setTimeout(()=>msg.textContent='',2000);
    }
}

// ì‚¬ì§„ JSON ë‹¤ìš´ë¡œë“œ (HTML ì„í¬íŠ¸ìš©)
function downloadAllPhotos(){
    const store=getStore();
    const result=[];
    EMP.forEach(e=>{
        const photo=store['photo_'+e.name+'|'+e.team];
        if(photo) result.push({name:e.name,division:e.division,team:e.team,position:e.position,photo});
    });
    if(!result.length){toast('ë“±ë¡ëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.','err');return;}
    downloadJSON(result,`ì‚¬ì§„_ì „ì²´_${result.length}ëª…`);
    toast(`${result.length}ëª… ì‚¬ì§„ JSON â†’ ì§ì›ì •ë³´ê³µìœ .htmlì—ì„œ "JSON íŒŒì¼ ë³‘í•©"ìœ¼ë¡œ ì„í¬íŠ¸`,'ok');
}

// ì‚¬ì§„ ì œì¶œí˜„í™© CSV
function downloadPhotoStatus(){
    const store=getStore();
    const rows=[['ì´ë¦„','ë³¸ë¶€','íŒ€','ì§ê¸‰','ì‚¬ì§„ ì œì¶œì—¬ë¶€']];
    EMP.forEach(e=>{
        rows.push([e.name,e.division,e.team,e.position,store['photo_'+e.name+'|'+e.team]?'ì™„ë£Œ':'ë¯¸ì œì¶œ']);
    });
    downloadCSV(rows,'ì‚¬ì§„_ì œì¶œí˜„í™©');
    toast('ì‚¬ì§„ ì œì¶œí˜„í™© CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!','ok');
}

// ë‹´ë‹¹ì—…ë¬´ ì „ì²´ JSON (ëª¨ë“  íŒ€ ì·¨í•© â€” HTML ì„í¬íŠ¸ìš©)
function downloadAllTasksJSON(){
    const store=getStore();
    const result=[];
    EMP.forEach(e=>{
        const tasks=store['task_'+e.name+'|'+e.team];
        if(tasks&&tasks.length) result.push({name:e.name,division:e.division,team:e.team,position:e.position,primaryTasks:tasks});
    });
    if(!result.length){toast('ì €ì¥ëœ ì—…ë¬´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.','err');return;}
    downloadJSON(result,`ë‹´ë‹¹ì—…ë¬´_ì „ì²´_${result.length}ëª…`);
    toast(`${result.length}ëª… ì—…ë¬´ JSON â†’ ì§ì›ì •ë³´ê³µìœ .htmlì—ì„œ "JSON íŒŒì¼ ë³‘í•©"ìœ¼ë¡œ ì„í¬íŠ¸`,'ok');
}

// ë‹´ë‹¹ì—…ë¬´ ì „ì²´ CSV (ì—‘ì…€ìš©)
function downloadAllTasksCSV(){
    const store=getStore();
    const rows=[['ì´ë¦„','ë³¸ë¶€','íŒ€','ì§ê¸‰','ì£¼ì—…ë¬´1','ì£¼ì—…ë¬´2','ì—…ë¬´3','ì—…ë¬´4','ì—…ë¬´5','ì…ë ¥ì—¬ë¶€']];
    EMP.forEach(e=>{
        const tasks=store['task_'+e.name+'|'+e.team]||[];
        const row=[e.name,e.division,e.team,e.position];
        for(let j=0;j<5;j++) row.push(tasks[j]||'');
        row.push(tasks.length?'ì™„ë£Œ':'ë¯¸ì…ë ¥');
        rows.push(row);
    });
    downloadCSV(rows,'ë‹´ë‹¹ì—…ë¬´_ì „ì²´');
    toast('ë‹´ë‹¹ì—…ë¬´ ì „ì²´ CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!','ok');
}

// í†µí•© JSON (ì—…ë¬´ + ì‚¬ì§„) â€” ì§ì›ì •ë³´ê³µìœ .html mergeJSON ìœ¼ë¡œ ë°”ë¡œ ì„í¬íŠ¸
function downloadAllMergedJSON(){
    const store=getStore();
    const result=[];
    let taskCnt=0,photoCnt=0;
    EMP.forEach(e=>{
        const tasks=store['task_'+e.name+'|'+e.team];
        const photo=store['photo_'+e.name+'|'+e.team];
        if((tasks&&tasks.length)||photo){
            const obj={name:e.name,division:e.division,team:e.team,position:e.position};
            if(tasks&&tasks.length){obj.primaryTasks=tasks;taskCnt++;}
            if(photo){obj.photo=photo;photoCnt++;}
            result.push(obj);
        }
    });
    if(!result.length){toast('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.','err');return;}
    downloadJSON(result,`í†µí•©_ì—…ë¬´${taskCnt}ëª…_ì‚¬ì§„${photoCnt}ëª…`);
    toast(`í†µí•© JSON(ì—…ë¬´ ${taskCnt}ëª… + ì‚¬ì§„ ${photoCnt}ëª…) â†’ ì§ì›ì •ë³´ê³µìœ .htmlì—ì„œ "JSON íŒŒì¼ ë³‘í•©"ìœ¼ë¡œ ì„í¬íŠ¸`,'ok');
}

// ===== n8n ì„œë²„ ë°ì´í„° ì¡°íšŒ =====
function fetchN8nData(mode){
    if(!ADMIN_URL){toast('ADMIN_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.','err');return;}
    const url=ADMIN_URL+(ADMIN_URL.includes('?')?'&':'?')+'mode='+mode;
    fetch(url).then(r=>r.json()).then(data=>{
        const el=document.getElementById('n8nResult');
        if(mode==='status'){
            el.innerHTML=`<div style="background:#f0f7ff;border:1px solid #bfdbfe;border-radius:8px;padding:14px;font-size:13px;line-height:1.7;">
                <b>â˜ï¸ ì„œë²„ ì·¨í•© í˜„í™©</b><br>
                ğŸ“‹ ë‹´ë‹¹ì—…ë¬´ ì…ë ¥ ì™„ë£Œ: <b style="color:var(--accent);">${data.taskCount}ëª…</b><br>
                ğŸ“· ì‚¬ì§„ ë“±ë¡ ì™„ë£Œ: <b style="color:var(--green);">${data.photoCount}ëª…</b><br>
                ğŸ“ ì´ ì œì¶œ íšŸìˆ˜: ${data.totalSubmissions}íšŒ
                ${data.taskNames&&data.taskNames.length?'<br><br><b>ì—…ë¬´ ì…ë ¥ ì™„ë£Œ:</b><br><span style="font-size:12px;color:var(--sub);">'+data.taskNames.join(', ')+'</span>':''}
                ${data.photoNames&&data.photoNames.length?'<br><br><b>ì‚¬ì§„ ë“±ë¡ ì™„ë£Œ:</b><br><span style="font-size:12px;color:var(--sub);">'+data.photoNames.join(', ')+'</span>':''}
            </div>`;
            toast('ì„œë²„ í˜„í™© ì¡°íšŒ ì™„ë£Œ!','ok');
        } else {
            // JSON ë‹¤ìš´ë¡œë“œ
            const result=Array.isArray(data)?data:(data.result||[data]);
            const prefix=mode==='all'?'ì„œë²„_í†µí•©':mode==='tasks'?'ì„œë²„_ì—…ë¬´':'ì„œë²„_ì‚¬ì§„';
            downloadJSON(result,prefix+'_'+result.length+'ê±´');
            el.innerHTML=`<div style="font-size:12px;color:var(--green);font-weight:600;">âœ… ${result.length}ê±´ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ</div>`;
            toast(`ì„œë²„ ë°ì´í„° ${result.length}ê±´ JSON ë‹¤ìš´ë¡œë“œ!`,'ok');
        }
    }).catch(e=>{
        toast('ì„œë²„ ì—°ê²° ì‹¤íŒ¨: '+e.message,'err');
    });
}

// ===== ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ë‹«ê¸° =====
document.getElementById('photoModal').addEventListener('click',function(e){
    if(e.target===this) closePhotoModal();
});

// ===== ê³µí†µ =====
function downloadJSON(data,prefix){
    const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    a.download=prefix+'_'+new Date().toISOString().slice(0,10)+'.json';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function downloadCSV(rows,prefix){
    const BOM='\uFEFF';
    const csv=rows.map(r=>r.map(c=>{
        const s=String(c).replace(/"/g,'""');
        return /[,"\n\r]/.test(s)?`"${s}"`:s;
    }).join(',')).join('\r\n');
    const b=new Blob([BOM+csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    a.download=prefix+'_'+new Date().toISOString().slice(0,10)+'.csv';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
}

function toast(m,t){const el=document.getElementById('toast');el.textContent=m;el.className='toast '+(t==='ok'?'ok':t==='err'?'err':'');setTimeout(()=>el.classList.add('show'),10);setTimeout(()=>el.classList.remove('show'),2500);}

// ì´ˆê¸°í™”
initLeadSel();
initPhotoList();
// n8n ì—°ë™ ì˜ì—­ í‘œì‹œ
if(ADMIN_URL){const el=document.getElementById('n8nAdminArea');if(el)el.style.display='block';}
</script>
</body>
</html>
